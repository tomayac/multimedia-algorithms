<!DOCTYPE html> 
<html lang="en"> 
  <head> 
    <meta charset="UTF-8"> 
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"> 
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.6.2/jquery.min.js" type="text/javascript"></script> 
    <script src="histogram.js" type="text/javascript"></script>
    <script src="stat.js" type="text/javascript"></script>    
    <style>
      BODY {
        font-family: sans-serif;
        font-size: 12pt;
      }
      DIV.strip {
        float: left;
        border: solid green 1px;
      }
      DIV.break {
        margin-left: 52px;
        float:left;
        border: solid red 1px;
      }      
      UL LI {
        display: inline;
      }
      SMALL {
        font-size: 0.5em;
      }
    </style>
  </head> 
  <body> 
    <div>
      <input id="video_id" value="Hu-YsZNpkZs" />
      <button id="start">OK</button>
    </div> 
    <div style="float:left;" id="video"> 
      <video controls></video>
      <br/>
      <input size="2" id="rows" type="range" min="1" max="20" step="1"/>
      <input id="rows_value"/> Rows
      <br/>
      <input size="2" id="cols" type="range" min="1" max="20" step="1"/>
      <input id="cols_value"/> Columns
      <br/>
      <input size="2" id="threshold" type="range" min="1" max="300" step="1"/>
      <input id="threshold_value"/> Scene Threshold
    </div>     
    <div style="float:left;" id="average_canvas"></div>             
    <div style="clear:both;" id="scenes"> 
      <ul></ul> 
    </div> 

    <script> 
      (function () {
        function removeAllChildNodes(elem) {
          while(elem.hasChildNodes()){
            elem.removeChild(elem.lastChild);
          }
        }
        
        // Core bits adapted (stolen) from
        // http://isithackday.com/videograbber/
        function formatTime(time) {
          var hours = parseInt((time / 60 / 60) % 60, 10),
              mins = parseInt((time / 60) % 60, 10),
              secs = parseInt(time, 10) % 60,
              hourss = (hours < 10 ? '0' : '') + parseInt(hours, 10) + ':',
              minss = (mins < 10 ? '0' : '') + parseInt(mins, 10) + ':',
              secss  = (secs < 10 ? '0' : '') +(secs % 60),
              timestring = ( hourss !== '00:' ? hourss : '' ) + minss + secss;
          return timestring;
        }
        
        var startButton = document.getElementById('start');
        startButton.addEventListener('click', function(e) {
          start(document.getElementById('video_id').value);
        }, false);
        
        var video = document.querySelector('video');        
        video.height = '200';
        
        var averageCanvas = document.getElementById('average_canvas');        
        
        var scenes = document.querySelector('#scenes ul');
        
        var rowsSlider = document.getElementById('rows');
        var rowsValue = document.getElementById('rows_value');
        
        var colsSlider = document.getElementById('cols');
        var colsValue = document.getElementById('cols_value');
        
        var thresholdSlider = document.getElementById('threshold');
        var thresholdValue = document.getElementById('threshold_value');        
        
        var rows = 3;            
        rowsValue.value = rows;
        rowsSlider.value = rows;
        var cols = 3;        
        colsValue.value = cols;
        colsSlider.value = cols;
        var rows_x_cols = rows * cols;
        
        rowsSlider.addEventListener('change', function(e) {
          rows = this.value;
          rows_x_cols = rows * cols;
          rowsValue.value = rows;          
        }, false);

        colsSlider.addEventListener('change', function(e) {
          cols = this.value;
          rows_x_cols = rows * cols;
          colsValue.value = cols;
        }, false); 
        
        var threshold = 50;
        thresholdValue.value = threshold;
        thresholdSlider.value = threshold;
        var distances = [];
        thresholdSlider.addEventListener('change', function(e) {
          threshold = this.value;
          thresholdValue.value = threshold;
          
          var stripDivs = document.querySelectorAll('.strip');
          for (var i = 0, len = stripDivs.length; i < len; i++) {
            var div = stripDivs[i];
            var distance = distances[i];
            div.classList.remove('break');
            if (distance > threshold) {
              div.classList.add('break');
            }
          }
        }, false);
        
        var canvas = document.createElement('canvas');       
        var avgCanvas = document.createElement('canvas');
        
        function start(id) {          
          $.ajax({
            dataType: 'json',      
            url: "http://tomayac.com/youpr0n/proxy.php?video=" + id,
            success: function(data) {
              distances = [];
              removeAllChildNodes(video);
              for (var i = 0, len = data.length; i < len; i++) {
                var source = document.createElement('source');
                source.src = data[i].url;
                if (data[i].type) {
                  source.type = data[i].type
                }
                video.appendChild(source);
              }
            }
          });
 
         video.addEventListener('play', function(e) {
           if (video.currentTime === 0) {
             removeAllChildNodes(scenes);
           }
         }, false);
 
          video.addEventListener('loadedmetadata', function(e) {
            console.log('loadedmetadata');
            var videoWidth = video.videoWidth;
            var videoHeight = video.videoHeight;
            var videoRatio = videoWidth / videoHeight;
            video.volume = 0;
          
            var canvasWidth = 50;
            var canvasHeight = ~~(canvasWidth / videoRatio);            
            canvas.width = canvasWidth;
            canvas.height = canvasHeight;          
            canvas.style.border = '2px solid green';
            
            avgCanvas.width = canvasWidth;
            avgCanvas.height = canvasHeight;            
            
            var ctx = canvas.getContext('2d');
            var avgCtx = avgCanvas.getContext('2d');
            
            var lastFrame = null;            
            
            var abs = Math.abs;            
            video.addEventListener('loadeddata', function(e) {
              console.log('loadeddata');
              var step = 0.5;
              video.currentTime = 0;
              var html = {};
              var counter = 0;
              FICKEN_complexDistances = [0,0,0,0,0,0,0,0,0];
              var interval = setInterval(function() {                
                var currentTime = video.currentTime;
                var sw = ~~(videoWidth / cols);
                var sh = ~~(videoHeight / rows);
                var dw = ~~(canvasWidth / cols);
                var dh = ~~(canvasHeight / rows);

                var thisFrame = {};

                for (var i = 0; i < rows_x_cols; i++) {
                  var mod = (i % cols);
                  var div = ~~(i / cols); 
                  var sx = mod * sw;
                  var sy = div * sh;
                  var dx = mod * dw;
                  var dy = div * dh;
                  ctx.drawImage(video, sx, sy, sw, sh, dx, dy, dw, dh);
                  var histogram =
                      Histogram.getHistogram(ctx, dx, dy, dw, dh, false);
                  avgCtx.fillStyle = histogram.css;
                  avgCtx.fillRect(dx, dy, dw, dh);

                  thisFrame[i] = histogram.average;
                }
                thisFrame.average = 0;
                for (var i = 0; i < rows_x_cols; i++) {
                  thisFrame.average += thisFrame[i];
                }
                if (!lastFrame) {
                  lastFrame = thisFrame;
                }
                thisFrame.average = ~~(thisFrame.average / rows_x_cols);
                var distance = abs(thisFrame.average - lastFrame.average);
                var complexDistance = [];
                for (var i = 0; i < rows_x_cols; i++) {
                  complexDistance[i] = abs(thisFrame[i] - lastFrame[i]);
                  FICKEN_complexDistances[i] += complexDistance[i];
                }
                var max = Math.max.apply(null, complexDistance);
                var min = Math.min.apply(null, complexDistance);
                //console.log(complexDistance);
                
                var mostSimilarTile = complexDistance.indexOf(min);
                var mostDifferentTile = complexDistance.indexOf(max);
                console.log(counter + ' === ' + mostDifferentTile + ' === ' + mostSimilarTile);                
                distances.push(distance);
                var time = parseFloat(currentTime);
                lastFrame = thisFrame;
                
                var src = canvas.toDataURL('image/png');
                var divCss = null;
                if (distance > threshold) {
                  divCss = 'class="break strip"';
                } else {
                  divCss = 'class="strip"';
                }                
                html[counter] = 
                    '<li><div ' + divCss + '><img src="' + src + '"/>' +
                    '<br/><small>' + formatTime(time) + ' / ' +
                    '<strong>' + distance + '</strong></small></div></li>';               
                                
                var nextTime = currentTime + step;                                                
                if (nextTime > video.duration) {
                  clearInterval(interval);
                  var timestamps = Object.keys(html);
                  timestamps.sort(function(a, b) { return a-b; });
                  var innerHtml = '';
                  for (var i = 0, len = timestamps.length; i < len; i++) {
                    innerHtml += html[timestamps[i]];
                  }
                  scenes.innerHTML = innerHtml;
                  video.currentTime = 0;
                  var average = ~~Stat.getAverage(distances);
                  var standardDeviation = ~~Stat.getStandardDeviation(distances);                  
                  console.log('Average Distance: ' + average);
                  console.log('Standard Deviation Distance: ' + standardDeviation);                                
                  thresholdSlider.value = standardDeviation;
                  thresholdValue.value = standardDeviation;
                } else {
                  video.currentTime = nextTime;
                }
                counter++;                
              }, 100);
            }, false);       
          }, false);
        } 
      })();
    </script> 
  </body> 
</html>