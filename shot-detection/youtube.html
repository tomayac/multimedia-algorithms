<!DOCTYPE html> 
<html lang="en"> 
  <head> 
    <meta charset="UTF-8"> 
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"> 
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.6.2/jquery.min.js" type="text/javascript"></script> 
    <script src="histogram.js" type="text/javascript"></script>
    <style>
      BODY {
        font-family: sans-serif;
        font-size: 12pt;
      }
      DIV.strip {
        float: left;
      }
      IMG.break {
        border: solid 1px red;
      }
      UL LI {
        display: inline;
      }
      SMALL {
        font-size: 0.5em;
      }
    </style>
  </head> 
  <body> 
    <div>
      <input id="video_id" value="xtg6wZLTvuY" />
      <button id="start">OK</button>
    </div> 
    <div style="float:left;" id="video"> 
      <video controls></video> 
      <br/>
      <input size="2" id="rows" type="range" min="1" max="20" step="1"/>
      <input id="rows_value"/> Rows
      <br/>
      <input size="2" id="cols" type="range" min="1" max="20" step="1"/>
      <input id="cols_value"/> Columns
      <br/>
      <input size="2" id="threshold" type="range" min="1" max="300" step="1"/>
      <input id="threshold_value"/> Scene Threshold
    </div>     
    <div style="float:left;" id="average_canvas"></div>             
    <div style="clear:both;" id="scenes"> 
      <ul></ul> 
    </div> 

    <script> 
      (function () {
        var startButton = document.getElementById('start');
        startButton.addEventListener('click', function(e) {
          start(document.getElementById('video_id').value);
        }, false);
        
        var video = document.querySelector('video');
        video.height = '200';
        
        var averageCanvas = document.getElementById('average_canvas');        
        
        var scenes = document.querySelector('#scenes ul');
        
        var rowsSlider = document.getElementById('rows');
        var rowsValue = document.getElementById('rows_value');
        
        var colsSlider = document.getElementById('cols');
        var colsValue = document.getElementById('cols_value');
        
        var thresholdSlider = document.getElementById('threshold');
        var thresholdValue = document.getElementById('threshold_value');        
        
        var rows = 3;            
        rowsValue.value = rows;
        var cols = 3;        
        colsValue.value = cols;
        var rows_x_cols = rows * cols;
        
        rowsSlider.addEventListener('change', function(e) {
          rows = this.value;
          rows_x_cols = rows * cols;
          rowsValue.value = rows;          
        }, false);

        colsSlider.addEventListener('change', function(e) {
          cols = this.value;
          rows_x_cols = rows * cols;
          colsValue.value = cols;
        }, false); 
        
        var threshold = 50;
        thresholdValue.value = threshold;
        thresholdSlider.addEventListener('change', function(e) {
          threshold = this.value;
          thresholdValue.value = threshold;
        }, false);         
        
        var canvas = document.createElement('canvas');       
        var avgCanvas = document.createElement('canvas');
        
        function start(id) {
          $.ajax({
            dataType: 'json',      
            url: "http://tomayac.com/youpr0n/proxy.php?video=" + id,
            success: function(data) {
              while(video.hasChildNodes()){
                video.removeChild(video.lastChild);
              }
              for (var i = 0, len = data.length; i < len; i++) {
                var source = document.createElement('source');
                source.src = data[i].url;
                source.type = data[i].type.replace('"', '\"');
                video.appendChild(source);
              }
            }
          });          
 
          video.addEventListener('loadedmetadata', function(e) {
            var videoWidth = video.videoWidth;
            var videoHeight = video.videoHeight;
            var videoRatio = videoWidth / videoHeight;
          
            var canvasWidth = 100; //~~(videoWidth / 2);
            var canvasHeight = ~~(canvasWidth / videoRatio);            
            canvas.width = canvasWidth;
            canvas.height = canvasHeight;          
            canvas.style.border = '2px solid green';
            
            avgCanvas.width = canvasWidth;
            avgCanvas.height = canvasHeight;          
            avgCanvas.style.border = '2px solid red';
            averageCanvas.appendChild(avgCanvas);        
            
            var ctx = canvas.getContext('2d');
            var avgCtx = avgCanvas.getContext('2d');
            
            var lastFrame = null;            
            var round2 = function(x) { return (~~(x *= 100)) / 100; };
            var abs = Math.abs;
            video.addEventListener('timeupdate', function(e) {
              var sw = ~~(videoWidth / cols);
              var sh = ~~(videoHeight / rows);
              var dw = ~~(canvasWidth / cols);
              var dh = ~~(canvasHeight / rows);
              
              var thisFrame = {};
              
              for (var i = 0; i < rows_x_cols; i++) {
                var mod = (i % cols);
                var div = ~~(i / cols); 
                var sx = mod * sw;
                var sy = div * sh;
                var dx = mod * dw;
                var dy = div * dh;
                ctx.drawImage(video, sx, sy, sw, sh, dx, dy, dw, dh);
                var histogram =
                    Histogram.getHistogram(ctx, dx, dy, dw, dh, false);
                avgCtx.fillStyle = histogram.css;
                avgCtx.fillRect(dx, dy, dw, dh);
                
                thisFrame['tile' + i] = histogram.average
              }
              thisFrame.average = 0;
              for (var i = 0; i < rows_x_cols; i++) {
                thisFrame.average += thisFrame['tile' + i];
              }
              if (!lastFrame) {
                lastFrame = thisFrame;
              }
              thisFrame.average = ~~(thisFrame.average / rows_x_cols);
              var distance = abs(thisFrame.average - lastFrame.average);
              var time = parseFloat(video.currentTime);
              lastFrame = thisFrame;
              
              var li = document.createElement('li');
              var src = canvas.toDataURL('image/png');
              var css = distance > threshold? 'class="break"' : '';
              li.innerHTML = 
                  '<div class="strip"><img src="' + src + '" ' + css + '/>' +
                  '<br/><small>' + round2(time) + ' / <strong>' +
                  distance + '</strong></small></div>';
              scenes.appendChild(li);
            }, false); 
          }, false);
        } 
      })();
    </script> 
  </body> 
</html>