<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <link rel=stylesheet href="main.css" type="text/css" />
    <script
        src="http://ajax.googleapis.com/ajax/libs/jquery/1.6.2/jquery.min.js"
        type="text/javascript"></script>
  </head>
  <body>
    <div class="embedded">
      <div>
        <form onsubmit="return false;">
          <input id="video_id" value="Hu-YsZNpkZs" />
          <button type="submit" id="start">OK</button>
          <small>
            <input id="debug" type="checkbox"/>
            <label for="debug"> Debug</label>
            <span id="debug_options">
              <input id="different" type="checkbox" checked />
              <label for="different"> Show Most Different Tiles</label>
              <input id="similar" type="checkbox" checked />
              <label for="similar"> Show Most Similar Tiles</label>
            </span>
          </small>
        </form>
      </div>
    
      <div class="video" id="video"></div> 
     
      <div>  
        <div>
          <div class="label"><small id="rows_min">1</small></div>
          <input id="rows" type="range" min="1" max="20" step="1"/>
          <div class="label"><small id="rows_max">20</small></div>
          <input class="options" id="rows_value"/> # Rows
          <br/>
        
          <div class="label"><small id="cols_min">1</small></div>
          <input id="cols" type="range" min="1" max="20" step="1"/>
          <div class="label"><small id="cols_max">20</small></div>
          <input class="options" id="cols_value"/> # Columns
          <br/>
        
          <div class="label"><small id="tiles_min">1</small></div>
          <input id="tiles" type="range" min="1" step="1"/>
          <div class="label"><small id="tiles_max"></small></div>
          <input class="options" id="tiles_value"/> # Most Different Tiles
          <br/>
        
          <div class="label"><small id="threshold_min">1</small></div>
          <input id="threshold" type="range" min="1" max="300" step="1"/>
          <div class="label"><small id="threshold_max">300</small></div>
          <input class="options" id="threshold_value"/> Scene Threshold
          <br/>
        
          <div class="label"><small id="boosting_min">1</small></div>
          <input id="boosting" type="range" min="1" max="2" step="0.1"/>
          <div class="label"><small id="boosting_max">2</small></div>
          <input class="options" id="boosting_value"/>
          Different Tile Boosting Factor
          <br/>
        
          <div class="label"><small id="limiting_min">0</small></div>
          <input id="limiting" type="range" min="0" max="1" step="0.1"/>
          <div class="label"><small id="limiting_max">1</small></div>
          <input class="options" id="limiting_value"/>
          Similar Tile Limiting Factor
          <br/>
        
          <input class="options" id="average"/> Frame Average Distance
          <br/>
        
          <input class="options" id="deviation"/> Frame Standard Deviation
          <br/>
        
          <input type="checkbox" id="keep_synced"/>
          <label for="keep_synced">
            Adjust Scene Threshold to Frame Standard Deviation
          </label>
        </div>
      </div>
    
      <div class="canvas" id="average_canvas"></div>
    
      <div class="progress" id="progress"></div>
    </div>
    <div class="scenes" id="scenes"></div>
    
    <script type="text/javascript">
      (function(){function be(e){function f(a){while(a.hasChildNodes())a.removeChild(a.lastChild)}c&&(clearInterval(c),c=null),f(t),f(w),$.ajax({dataType:"json",url:a.proxy+e,success:function(a){if(!a){var b="Cannot Embed Video.";alert(b);throw b}for(var c=0,d=a.length;c<d;c++){var e=document.createElement("source");e.src=a[c].url,a[c].type&&(e.type=a[c].type),t.appendChild(e)}t.load()}}),t.addEventListener("play",function(a){t.currentTime===0&&f(w)},!1),t.addEventListener("loadedmetadata",function(e){function w(){function e(a,b){var c=null,d=null,e=null,f=null,h=w-2,j=x-2;for(var k=0;k<V;k++){if(i){var l=a[k];c=l%G,d=~~(l/G),e=c*w,f=d*x,s.strokeStyle="red",s.strokeRect(e+1,f+1,h,j)}if(g){var m=b[k];c=m%G,d=~~(m/G),e=c*w,f=d*x,s.strokeStyle="green",s.strokeRect(e+1,f+1,h,j)}}}var f=a.step,h=~~(j/G),p=~~(k/z),w=~~(n/G),x=~~(r/z);t.currentTime=0;var y=t.duration,A=0,B=-1;c=setInterval(function(){I&&(h=~~(j/G),p=~~(k/z),w=~~(n/G),x=~~(r/z),I=!1);var g=t.currentTime;if(g<=B)t.currentTime+=f;else{B=g;var i=~~(g/y*100);i>q&&(d&&window.parent.postMessage({progress:i,type:"progress"},a.youtube),o.value=i,q=i);var m={};for(var C=0;C<H;C++){var D=C%G,E=~~(C/G),F=D*h,L=E*p,M=D*w,N=E*x;u.drawImage(t,F,L,h,p,M,N,w,x);var O=Histogram.getHistogram(u,M,N,w,x,!1);l&&(s.fillStyle=O.css,s.fillRect(M,N,w,x)),m[C]=O.average}m.average=0,v||(v=m);var P=_(m,v),Q=P.distance;l&&e(P.tileData.mostDifferentTiles,P.tileData.mostSimilarTiles),v=m,b[A]={time:g,dataUri:W.toDataURL("image/png"),distance:Q};var R=g+f;if(R>=y){clearInterval(c),o.value=100,d&&(window.parent.postMessage({progress:100,type:"progress"},a.youtube),window.parent.postMessage({type:"getCurrentTime"},a.youtube)),bc();var S=[];for(var C=0;C<A;C++)S[C]=b[C].distance.absolute;var T=~~Stat.getAverage(S),U=~~Stat.getStandardDeviation(S);J.value=U,K.value=U,ba(T,U)}else t.currentTime=R;A++}},m)}var f=Math.max,h=Math.min,j=t.videoWidth,k=t.videoHeight,p=j/k;t.volume=0;var r=~~(n/p);W.width=n,W.height=r,X.width=n,X.height=r;var s=X.getContext("2d"),u=W.getContext("2d"),v=null;t.addEventListener("loadeddata",function(a){w()},!1)},!1)}function bd(){var a=[],c=b[0].distance.tiles,d=c,e=_(c,d).distance;a[0]=e.absolute;var f=Object.keys(b).length;for(var g=1;g<f;g++)c=b[g].distance.tiles,d=b[g-1].distance.tiles,e=_(c,d).distance,a[g]=e.absolute;var h=~~Stat.getAverage(a),i=~~Stat.getStandardDeviation(a);ba(h,i);var j=document.querySelectorAll(".strip");for(var g=0,f=j.length;g<f;g++){var k=j[g];k.classList.remove("break");var l=a[g];l>L&&k.classList.add("break"),k.getElementsByTagName("strong")[0].innerHTML=l}}function bc(){function m(a,b){return a==="IMG"||a==="BR"?b.parentNode.lastChild:a==="SMALL"?b:a==="STRONG"?b.parentNode:a==="DIV"?b.lastChild:null}function l(a,b){return a==="IMG"||a==="SMALL"||a==="BR"?b.parentNode:a==="STRONG"?b.parentNode.parentNode:a==="DIV"?b:null}var c=Object.keys(b);c.sort(a.sortFunction);var e="";for(var f=0,g=c.length;f<g;f++){var h=b[f],i=h.distance.absolute,j=i>L?'class="break strip"':'class="strip"',k=h.time;e+='<div id="frame_'+k+'" '+j+'><img src="'+h.dataUri+'"/><br/><small data="'+k+'">'+bb(k)+(d?"":" / <strong>"+i+"</strong>")+"</small></div>"}w.innerHTML=e,w.addEventListener("mouseover",function(a){var b=null;b=l(a.target.nodeName,a.target),b&&(b.style.backgroundColor="#FAF8CC")},!1),w.addEventListener("mouseout",function(a){var b=null;b=l(a.target.nodeName,a.target),b&&(b.style.backgroundColor="transparent")},!1),w.addEventListener("click",function(b){var c=null;c=m(b.target.nodeName,b.target);if(c){var e=c.getAttribute("data");d?window.parent.postMessage({jumpTo:e,type:"jumpTo"},a.youtube):(t.currentTime=e,t.play())}},!1)}function bb(a){var b=parseInt(a/60/60%60,10),c=parseInt(a/60%60,10),d=parseInt(a,10)%60,e=(b<10?"0":"")+parseInt(b,10)+":",f=(c<10?"0":"")+parseInt(c,10)+":",g=(d<10?"0":"")+d%60,h=(e!=="00:"?e:"")+f+g;return h}function ba(a,b){A.value=a,B.value=b,D&&(J.value=b,K.value=b)}function _(b,c){var d=Math.abs,e=[];for(var f=0;f<H;f++)e[f]=d(b[f]-c[f]);var g=e.slice(0);g.sort(a.sortFunction);var h=[],i=[],j=null;for(var f=0;f<V;f++){var k=g[H-f-1];k>0&&(j=e.indexOf(k),i[f]=j,e[j]=null);var l=g[f];l<k&&(j=e.indexOf(l),h[f]=j,e[j]=null)}for(var f=0;f<H;f++){var m=b[f],n=1;h.indexOf(f)!==-1?n=R:i.indexOf(f)!==-1&&(n=O),b.average+=m*n}b.average=~~(b.average/H);var o={mostDifferentTiles:i,mostSimilarTiles:h},p={absolute:d(b.average-c.average),tiles:b};return{distance:p,tileData:o}}function Z(a,b){var c=Math.pow(10,b||0);return b?Math.round(c*a)/c:a}function Y(){S.max=H,U.innerHTML=H,H<V&&(V=H,S.value=V,T.value=V)}var a={normalTimeout:100,debugTimeout:500,normalCanvasWidth:70,debugCanvasWidth:300,videoHeight:200,rows:20,cols:20,boosting:2,limiting:.5,threshold:50,proxy:"http://tomayac.com/youpr0n/proxy.php?video=",youtube:"http://www.youtube.com",step:1,sortFunction:function(a,b){return a-b}},b={},c=null,d=window.parent.location.origin!==window.location.origin,e=document.querySelector(".embedded");d||e.classList.toggle("embedded"),d&&window.addEventListener("message",function(c){if(c.origin===a.youtube&&c.data.type==="currentTime"){var d=c.data.currentTime,e=Object.keys(b);for(var f=0,g=e.length;f<g;f++){var h=b[f].time;h===d?document.getElementById("frame_"+f).classList.add("current"):document.getElementById("frame_"+f).classList.remove("current")}}},!1);var f=document.getElementById("similar"),g=f.checked;f.addEventListener("change",function(a){g=this.checked},!1);var h=document.getElementById("different"),i=h.checked;h.addEventListener("change",function(a){i=this.checked},!1);var j=document.getElementById("debug"),k=document.getElementById("debug_options"),l=j.checked;k.classList.toggle("debug_options");var m=null,n=null;l?(m=a.debugTimeout,n=a.debugCanvasWidth):(m=a.normalTimeout,n=a.normalCanvasWidth),j.addEventListener("change",function(b){l=j.checked,k.classList.toggle("debug_options"),l?(v.appendChild(W),v.appendChild(X),m=a.debugTimeout,n=a.debugCanvasWidth):(X.parentNode.removeChild(X),W.parentNode.removeChild(W),m=a.normalTimeout,n=a.normalCanvasWidth)},!1);var o=document.createElement("progress"),p=document.querySelector("#progress");d||p.appendChild(o),o.max=100;var q=0;o.value=q;var r=document.getElementById("video_id"),s=document.getElementById("start");s.addEventListener("click",function(a){be(r.value)},!1);var t=document.createElement("video");t.controls="controls";var u=document.querySelector("DIV.video");d||u.appendChild(t),t.height=a.videoHeight;var v=document.getElementById("average_canvas"),w=document.querySelector("#scenes"),x=document.getElementById("rows"),y=document.getElementById("rows_value"),z=a.rows;y.value=z,x.value=z,x.addEventListener("change",function(a){z=this.value,H=z*G,Y(),y.value=z,I=!0},!1);var A=document.getElementById("average");A.value=0;var B=document.getElementById("deviation");B.value=0;var C=document.getElementById("keep_synced"),D=C.checked;C.addEventListener("change",function(a){D=this.checked,D&&(L=B.value,J.value!==L&&(J.value=L,K.value=L,bd()))},!1);var E=document.getElementById("cols"),F=document.getElementById("cols_value"),G=a.cols;F.value=G,E.value=G;var H=z*G,I=!1;E.addEventListener("change",function(a){G=this.value,H=z*G,Y(),F.value=G,I=!0},!1);var J=document.getElementById("threshold"),K=document.getElementById("threshold_value"),L=a.threshold;K.value=L,J.value=L,J.addEventListener("change",function(a){L!==this.value&&(L=this.value,K.value=L,bd())},!1);var M=document.getElementById("boosting"),N=document.getElementById("boosting_value"),O=a.boosting;M.value=O,N.value=O,M.addEventListener("change",function(a){O!==this.value&&(O=Z(this.value,1),N.value=O,bd())},!1);var P=document.getElementById("limiting"),Q=document.getElementById("limiting_value"),R=a.limiting;P.value=R,Q.value=R,P.addEventListener("change",function(a){R!==this.value&&(R=Z(this.value,1),Q.value=R,bd())},!1);var S=document.getElementById("tiles"),T=document.getElementById("tiles_value"),U=document.getElementById("tiles_max"),V=~~(H/3);S.max=H,U.innerHTML=H,S.value=V,T.value=V,S.addEventListener("change",function(a){V=this.value,T.value=V},!1);var W=document.createElement("canvas"),X=document.createElement("canvas");l&&(v.appendChild(W),v.appendChild(X)),function(){var a=window.location.getParameter("v");a&&(r.value=a,be(a))}()})();var Histogram=function(a){return{getHistogram:function(a,b,c,d,e,f){var g=b||0,h=c||0,i=d||a.canvas.width,j=e||a.canvas.height,k=f||!1;if(k){var l=[];for(var m=0;m<256;m++)l[m]=0}var n=a.getImageData(g,h,i,j).data,o=i*j,p=o,q=o*4,r=Math.round,s={r:0,g:0,b:0};while(o--){var t=n[q-=4],u=n[q+1],v=n[q+2];s.r+=t,s.g+=u,s.b+=v,k&&l[r(t*.3+u*.59+v*.11)]++}var t=~~(s.r/p),u=~~(s.g/p),v=~~(s.b/p);return k?{values:l,pixel:{r:t,g:u,b:v},average:t+u+v,css:"rgb("+t+","+u+","+v+")"}:{pixel:{r:t,g:u,b:v},average:t+u+v,css:"rgb("+t+","+u+","+v+")"}}}}(window),Stat=function(a){var b=function(a,b){var c=Math.pow(10,b||0);return b?Math.round(c*a)/c:a},c={getAverage:function(a,c){if(!Array.isArray(a))return!1;var d=a.length,e=0;while(d--)e+=a[d];return b(e/a.length,c)},getVariance:function(a,d){if(!Array.isArray(a))return!1;var e=c.getAverage(a,d),f=a.length,g=0;while(f--)g+=Math.pow(a[f]-e,2);g/=a.length;return b(g,d)},getStandardDeviation:function(a,d){if(!Array.isArray(a))return!1;var e=Math.sqrt(c.getVariance(a,d));return b(e,d)}};return c}(window)    
    </script>
  </body>
</html>